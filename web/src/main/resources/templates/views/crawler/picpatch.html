
<style>
    .form-group{
        margin-bottom: 5px !important;
    }

    .scroll-box {
        height:375px;
        border:2px solid #000;
        overflow-y: auto;
        overflow-x: hidden;
        background: #F8F8F8;
    }
    .scroll-box ul {
        list-style:none;
        width:100%;
        height:100%;
        margin-left: 10px;
    }
    .scroll-box ul li {
        width:100%;
        height:20px;
        box-sizing:border-box;
        line-height:20px;
        text-align:left;
        color: #000;
        overflow-x: hidden;
    }

    .marginleft{
        margin-left: -12px;
    }
    .marginleft8{

        padding-bottom: 6px;
    }

    .table-bordered>thead>tr>th {border-bottom-width:3px !important;}

    .icheckbox_flat-blue, .iradio_flat-blue {
        transform: scale(1.7,1.7);
        margin-right: 5px;
    }
    .checkbox{
        padding-left: 10px;
    }

</style>

<div class="page-content">

    <div class="page-header marginleft8">
        <h1><i class="ace-icon fa fa-image"></i> 图片补丁
            <small>
                <i class="ace-icon fa fa-angle-double-right"></i>overview &amp; Ver20210304
            </small>
        </h1>
    </div><!-- /.page-header -->

    <div class="page-body">
        <div class="ol-xs-12 col-sm-12 col-md-12">
            <div class="col-xs-12 col-sm-6 col-md-3">

                <div class="row">
                    <h3 class="header smaller lighter green marginleft">爬虫配置</h3>
                    <form id="patch-form" method="patch-form" class="form-horizontal">
                        <div class="form-group">
                            <div class="col-md-6 col-xs-6 form-group">
                                <label for="searchKey">查询关键字：</label>
                                <input type="text" class="form-control" id="searchKey" name="searchKey" value="" data-bv-notempty="true" data-bv-notempty-message="不能为空" />
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-6 col-xs-6 form-group">
                                <label for="sleepTime">间隔时间（毫秒）：</label>
                                <input type="text" class="form-control" id="sleepTime" name="sleepTime" value=30000 />
                            </div>
                        </div>
                        <div class="form-group">
                            <input type="checkbox" data-flag="icheck" class="square-grey" value="1"  id="forPerson" name="forPerson">&nbsp;&nbsp;爬取人物作品海报
                        </div>

                        <div class="form-group">
                            <input type="checkbox"  data-flag="icheck" class="square-grey"  value="1"  id="forFilm" name="forFilm">&nbsp;&nbsp;爬取电影人物头像
                        </div>

                        <div class="form-group left">
                            <!--以下两种方式提交验证,根据所需选择-->
                            <button type="submit" class="btn btn-success" data-btn-type="start">开爬</button>
                            <button type="button" class="btn btn-danger" onclick="endCrawler();" data-btn-type="end">终止</button>
                        </div>
                    </form>
                </div>


                <div class="row">
                    <h3 class="header smaller lighter orange marginleft">关联配置</h3>
                    <form id="relevance-form" method="relevance-form" class="form-horizontal">
                            <div class="form-group">
                                <input type="checkbox" value="1"   data-flag="icheck" class="square-blue"   id="relevantInit" name="relevantInit">&nbsp;&nbsp;清空已关联数据
                            </div>
                            <div class="form-group">
                                <input type="checkbox" value="1"   data-flag="icheck" class="square-blue"   id="relevantAll" name="relevantAll">&nbsp;&nbsp;全新关联（默认只执行未关联的Media）
                            </div>

                            <div class="form-group left">
                                <button type="submit" class="btn btn-warning" data-btn-type="save">关联</button>
                            </div>
                    </form>
                </div>

            </div>

            <div class="col-xs-12 col-sm-6 col-md-5">
                    <div class="dataTables_filter alert-block pull-left" id="searchDivMiddle" style="margin-left: -6px;">
                        <input placeholder="请输入片名" name="subjectMain" class="form-control" type="search" likeOption="true"/>
                        <input placeholder="请输入年份" name="year" class="form-control" type="search" />
                        <input type="hidden" name="PersonNo" value="-1" id="PersonNo"/>
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary" data-btn-type="search"><i class="fa fa-search"></i></button>
                            <button type="button" class="btn btn-default" data-btn-type="refresh"><i class="fa fa-refresh"></i></button>
                            <button type="button" class="btn btn-default" data-btn-type="reset"><i class="fa fa-mail-reply"></i></button>
                        </div>
                        <div class="checkbox pull-right">
                            <label>
                                <input type="checkbox" id="checkRefresh"> 自动刷新
                            </label>
                        </div>
                    </div>
<!--                <div class="col-md-12">-->
                    <table id="${dataMiddleTableId}" class="table table-bordered table-hover dataTable" width="100%">
                    </table>
<!--                </div>-->
            </div>
            <div class="col-xs-12 col-sm-6 col-md-4">
                <div class="dataTables_filter alert-block  pull-left" id="searchDivRight"  style="margin-left: -6px;">
                    <input type="hidden" name="FilmNo" value="-1" id="FilmNo"/>
                    <input placeholder="请输入姓名" name="nameExtend" class="form-control" type="search" likeOption="true"/>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" data-btn-type="search"><i class="fa fa-search"></i></button>
                        <button type="button" class="btn btn-default" data-btn-type="refresh"><i class="fa fa-refresh"></i></button>
                        <button type="button" class="btn btn-default" data-btn-type="reset"><i class="fa fa-mail-reply"></i></button>
                    </div>
                    <div class="checkbox pull-right">
                        <label>
                            <input type="checkbox" id="checkRefreshRight"> 自动刷新
                        </label>
                    </div>
                </div>
                <table id="${dataRightTableId}" class="table table-bordered table-hover dataTable" width="100%">
                </table>
            </div>

        </div>
    </div>
</div>

<script src="common/js/dataTables_render.js"></script>
<script>
    //tableId,queryId,conditionContainer
    var pacthform =null;
    var winId = "user-win";
    var middleTable,rightTable;
    var middleUrl ="${dataMiddleTable}";
    var rightUrl ="${dataRightTable}";

    //刷新表格
    function refresh(){
        $("#PersonNo").val("-1");
        console.log("刷新表格" + new Date().toLocaleString());
        middleTable.reloadData();
    }
    function refreshRight(){
        $("#FilmNo").val("-1");
        console.log("刷新表格" + new Date().toLocaleString());
        rightTable.reloadData();
    }

    $(function() {
        if ($('#checkRefresh')[0]) {
            $('#checkRefresh').iCheck({
                checkboxClass: 'icheckbox_flat-blue', //选择框的风格。
                radioClass: 'icheckbox_flat-blue',
            });

            $('#checkRefresh').on('ifChanged', function (event) {
                if ($(this).is(':checked')) {
                    console.log("开启定时刷新");
                    localStorage.setItem("is_f", 2);
                    tf = setInterval('refresh()', 20000); //指定秒刷新一次
                } else {
                    console.log("关闭定时刷新");
                    clearInterval(tf); //取消自动刷新
                    localStorage.setItem("is_f", 0);
                }
            })
            //定时刷新
            is_f = localStorage.getItem("is_f");
            if(is_f == 2){
                console.log("默认开启定时刷新");
                $('#checkRefresh').iCheck("check");
            }
        }

        if ($('#checkRefreshRight')[0]) {
            $('#checkRefreshRight').iCheck({
                checkboxClass: 'icheckbox_flat-blue', //选择框的风格。
                radioClass: 'icheckbox_flat-blue',
            });

            $('#checkRefreshRight').on('ifChanged', function (event) {
                if ($(this).is(':checked')) {
                    console.log("开启定时刷新");
                    localStorage.setItem("is_r", 2);
                    tf = setInterval('refreshRight()', 20000); //指定秒刷新一次
                } else {
                    console.log("关闭定时刷新");
                    clearInterval(tf); //取消自动刷新
                    localStorage.setItem("is_r", 0);
                }
            })
            //定时刷新
            is_r = localStorage.getItem("is_r");
            if(is_r == 2){
                console.log("默认开启定时刷新");
                $('#checkRefreshRight').iCheck("check");
            }
        }

        //init table and fill data
        var middle_config={
            lengthChange:false,
            pagingType:'simple',
            language: {
                "sUrl": basePath + "/common/json/zh_CN_Sub.json"
            },
            rowClick:function(row,isSelected){
                console.log(row);
                $("#FilmNo").val(isSelected?row.doubanNo:"-1");
                if(isSelected)
                    rightTable.reloadData();
            }
        }
        var right_config={
            lengthChange:false,
            pagingType:'simple',
            language: {
                "sUrl": basePath + "/common/json/zh_CN_Sub.json"
            },
            rowClick:function(row,isSelected){
                console.log(row);
                $("#PersonNo").val(isSelected?row.douBanNo:"-1");
                if(isSelected)
                    middleTable.reloadData();
            }
        }
        middleTable = new CommonTable("${dataMiddleTableId}", middleUrl, "searchDivMiddle",middle_config);
        rightTable = new CommonTable("${dataRightTableId}", rightUrl,"searchDivRight",right_config);

        setTimeout(function () {
            middleTable.selectFirstRow(true);
        },500);

        // 关键词搜索框添加绑定回车函数
        //$("button[data-btn-type='search']").on('keypress', function(event) {
        $("#searchDivMiddle input").on('keypress', function(event) {
            if (event.keyCode == "13") {
                middleTable.reloadData();
                setTimeout(function () {
                    middleTable.selectFirstRow(true);
                },500);
            }
        })
        $("#searchDivRight input").on('keypress', function(event) {
            if (event.keyCode == "13") {
                rightTable.reloadData();
                setTimeout(function () {
                    rightTable.selectFirstRow(true);
                },500);
            }
        })
        //初始化控件
        pacthform=$("#patch-form").form();
        //数据校验
        $("#patch-form").bootstrapValidator({
            message : '请输入有效值',
            feedbackIcons : {
                valid : 'glyphicon glyphicon-ok',
                invalid : 'glyphicon glyphicon-remove',
                validating : 'glyphicon glyphicon-refresh'
            },
            submitHandler : function(validator, userform, submitButton) {
                modals.confirm('确认开始？', function() {
                    var params = pacthform.getFormSimpleData();
                    var searchKey = $("#searchKey").val();
                    var submitType = $(submitButton).attr("data-btn-type");
                    var objType = "person";
                    if ($("#forFilm").is(':checked')){
                        objType = "film";
                    }

                    ajaxPost(basePath+'/crawler/'+objType+'/picpatch?searchkey='+searchKey, params, function(data, status) {
                        if(data.msg == "success"){
                            if(id!="0"){//更新
                                modals.hideWin(winId);
                                //seriesTable.reloadRowData(id);

                            }else{//新增
                                //modals.info("数据保存成功");
                                modals.hideWin(winId);
                                // seriesTable.reloadData();
                            }
                        }
                    });
                });
            }
        });








        $(document).find('[data-flag="icheck"]').each(function () {
            var cls = $(this).attr("class") ? $(this).attr("class") : "square-green";
            $(this).iCheck(
                {
                    checkboxClass: 'icheckbox_' + cls,
                    radioClass: 'iradio_' + cls
                }
            ).on('ifChanged', function (e) {
                //var field = $(this).attr('name');
            });
        });


    });


    function endCrawler() {
        $.ajax({
            type: "get",
            url: "/crawler/stop",
            cache:false,
            async:true,
        });
        modals.info("终止请求发出成功！")
    }

</script>