<style>
    .form-group{
        margin-bottom: 5px !important;
    }

    .scroll-box {
        height:375px;
        border:2px solid #000;
        overflow-y: auto;
        overflow-x: hidden;
        background: #F8F8F8;
    }
    .scroll-box ul {
        list-style:none;
        width:100%;
        height:100%;
        margin-left: 10px;
    }
    .scroll-box ul li {
        width:100%;
        height:20px;
        box-sizing:border-box;
        line-height:20px;
        text-align:left;
        color: #000;
        overflow-x: hidden;
    }

</style>

<div class="page-content">

    <div class="page-header">
        <h1>爬虫配置 </h1>
    </div><!-- /.page-header -->

    <div class="page-body">


        <div class="col-xs-12 col-sm-12 col-md-12">
                <div class="col-xs-12 col-sm-6 col-md-4">
                    <div class="row">
                        <form id="crawler-form" method="crawler-form" class="form-horizontal">
                            <div class="form-group">
                                <label for="url">起始页面地址：(回车换行)</label>
                                <textarea  rows = "5" class="form-control" id="url" name="url" value="https://movie.douban.com/subject/10512661/" />
                            </div>
                            <div class="form-group hidden">
                                <div class="col-md-6 col-xs-6 form-group">
                                    <label for="thread">线程数：</label>
                                    <input type="text" class="form-control " id="thread" name="thread" value="1" />
                                </div>
                                <div  class="col-md-6 col-xs-6 form-group pull-right">
                                    <label for="thread">批量保存临界值: </label>
                                    <input type="text" class="form-control " id="batchNumber" name="batchNumber" value="10" />
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-6 col-xs-6 form-group">
                                    <label for="thread">间隔时间（毫秒）：</label>
                                    <input type="text" class="form-control" id="sleepTime" name="sleepTime" value=30000 />
                                </div>

                            </div>
                            <div class="form-group">
                                <div class=" col-md-6 col-xs-6 form-group">
                                    <input type="checkbox" data-flag="icheck" class="square-grey" value="1"  id="homepage" name="homepage">&nbsp;&nbsp;首页进入?
                                </div>
                                <div class="col-md-6 col-xs-6 form-group pull-right">
                                        <input type="checkbox"  data-flag="icheck" class="square-grey"  value="1"  id="mutil" name="mutil">&nbsp;&nbsp;延伸爬取?
                                </div>
                            </div>
                            <div class="form-group">
                                <div class=" form-group col-md-6 col-xs-6 ">
                                        <input type="checkbox"  data-flag="icheck" class="square-grey"  value="1"  id="filmOnly" name="filmOnly">&nbsp;&nbsp;只爬取电影?
                                </div>
                                <div class=" form-group col-md-6 col-xs-6 pull-right">
                                        <input type="checkbox"  data-flag="icheck" class="square-grey"  value="1"  id="personOnly" name="personOnly">&nbsp;&nbsp;只爬取影人?
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="form-group col-md-6 col-xs-6 ">
                                        <input type="checkbox"  data-flag="icheck" class="square-grey"  value="1"  id="directorEmpty" name="directorEmpty">&nbsp;&nbsp;导演可为空?
                                </div>
                                <div class="form-group col-md-6 col-xs-6  pull-right">
                                        <input type="checkbox"  data-flag="icheck" class="square-grey"  value="1"  id="actorEmpty" name="actorEmpty">&nbsp;&nbsp;演员可为空?
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="form-group col-md-6 col-xs-6 ">
                                    <input type="checkbox"  data-flag="icheck" class="square-grey"  value="1"  id="loginIn" name="loginIn">&nbsp;&nbsp;登录账号？
                                </div>
                                <div class="form-group col-md-6 col-xs-6  pull-right">
                                    <input type="checkbox"  data-flag="icheck" class="square-grey"  value="1"  id="ratingEmpty" name="ratingEmpty">&nbsp;&nbsp;豆分可为空？
                                </div>
                            </div>
                            <div class="form-group pull-right">
                                <!--以下两种方式提交验证,根据所需选择-->
                                <button type="submit" class="btn btn-success" data-btn-type="save">开爬</button>
                                <button type="button" class="btn btn-danger" onclick="endCrawler();" data-btn-type="end">终止</button>
                            </div>
                        </form>
                    </div>


                    <div class="row">
                        <h3 class="header smaller lighter blue">关联配置</h3>
                        <form id="relevance-form" method="relevance-form" class="form-horizontal">
                            <div class="form-group" style="line-height: 35px">
                                <input type="checkbox" value="1"   data-flag="icheck" class="square-blue"   id="relevantAll" name="relevantAll">&nbsp;&nbsp;关联全部?（默认只执行未关联的Media）
                                <button type="submit" class="btn btn-white btn-info btn-bold  pull-right"  data-btn-type="save">
                                    <i class="ace-icon fa fa-chain bigger-120 blue"></i>
                                    关联
                                </button>
                                <!--<button type="submit" class="btn btn-purple pull-right" data-btn-type="save">关联</button>-->
                            </div>

                        </form>
                    </div>
                </div>

                <div class="col-xs-12 col-sm-6 col-md-8">
                    <div class="row">
                    <div class="form-group">
                        <label style="margin-left: 30px;">运行日志：</label><input type="checkbox" data-flag="icheck" class="square-grey"  value="1"  id="refreshC" name="refreshC" ><input type="checkbox" data-flag="icheck" class="square-green pull-right"  value="1"  id="refresh" name="refresh" >
                        <div class="scroll-box" style="margin-left: 30px;">
                            <ul>
                            </ul>
                        </div>
                    </div>

                    </div>
                </div>



            </div>
    </div>
</div>

<script>
    //tableId,queryId,conditionContainer
    var crawlerform =null;
    var relevanceform =null;
    var winId = "user-win";
    var id="${id?default(0)}";
    $(function() {
        //初始化控件
        crawlerform=$("#crawler-form").form();
        //数据校验
        $("#crawler-form").bootstrapValidator({
            message : '请输入有效值',
            feedbackIcons : {
                valid : 'glyphicon glyphicon-ok',
                invalid : 'glyphicon glyphicon-remove',
                validating : 'glyphicon glyphicon-refresh'
            },
            submitHandler : function(validator, userform, submitButton) {
                modals.confirm('确认开始？', function() {
                    //Save Data，对应'submit-提交'
                    var params = crawlerform.getFormSimpleData();
                    ajaxPost(basePath+'/crawler/start', params, function(data, status) {
                        if(data.msg == "success"){
                            if(id!="0"){//更新
                                modals.hideWin(winId);
                                //seriesTable.reloadRowData(id);

                            }else{//新增
                                //modals.info("数据保存成功");
                                modals.hideWin(winId);
                               // seriesTable.reloadData();
                            }
                        }
                    });
                });
            }
        });
        crawlerform.initComponent();

        //初始化控件
        relevanceform=$("#relevance-form").form();
        //数据校验
        $("#relevance-form").bootstrapValidator({
            message : '请输入有效值',
            feedbackIcons : {
                valid : 'glyphicon glyphicon-ok',
                invalid : 'glyphicon glyphicon-remove',
                validating : 'glyphicon glyphicon-refresh'
            },
            submitHandler : function(validator, userform, submitButton) {
                modals.confirm('确认开始关联？', function() {
                    //Save Data，对应'submit-提交'
                    var params = relevanceform.getFormSimpleData();
                    // $.ajaxSetup({
                    //     async: true
                    // });
                    ajaxPost(basePath+'/relevance/start', params, function(data, status) {
                        if(data.msg == "success"){
                            if(id!="0"){//更新
                                modals.hideWin(winId);
                                //seriesTable.reloadRowData(id);

                            }else{//新增
                                //modals.info("数据保存成功");
                                modals.hideWin(winId);
                                // seriesTable.reloadData();
                                $("#url").val(data.data);
                                $("#refresh").iCheck('uncheck');
                                modals.alert("完成关联。")
                            }
                        }
                    }, true);

                });
            }
        });
        relevanceform.initComponent();


        window.clearInterval(int);
        int = setInterval(function () {

            if ($("#refresh").is(':checked')) {
                $.ajax({
                    type: "post",
                    url: "/relevance/log",
                    cache:false,
                    async:true,
                    success: function(result){
                        if (result.length > 0) {
                            $ul = $(".scroll-box ul");
                            $("<li>"+result+"</li>").prependTo($ul);


                        }

                    }
                });
            }

            if ($("#refreshC").is(':checked')) {
                $.ajax({
                    type: "post",
                    url: "/crawler/log",
                    cache:false,
                    async:true,
                    success: function(result){
                        if (result.length > 0) {
                            $ul = $(".scroll-box ul");
                            $("<li>"+result+"</li>").prependTo($ul);


                        }

                    }
                });
            }


        }, 100);



        $(document).find('[data-flag="icheck"]').each(function () {
            var cls = $(this).attr("class") ? $(this).attr("class") : "square-green";
            $(this).iCheck(
                {
                    checkboxClass: 'icheckbox_' + cls,
                    radioClass: 'iradio_' + cls
                }
            ).on('ifChanged', function (e) {
                //var field = $(this).attr('name');
            });
        });


    });



    
    function endCrawler() {
        $.ajax({
            type: "get",
            url: "/crawler/stop",
            cache:false,
            async:true,
        });

        modals.info("终止请求发出成功！")
    }
    
</script>